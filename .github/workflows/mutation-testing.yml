name: Mutation & Coverage Quality

on:
  workflow_dispatch: {}
  # Temporarily disabled automatic triggers
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  test-and-mutation:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run unit tests with coverage
        run: |
          python -m coverage run manage.py test api
          python -m coverage xml
          python -m coverage report -m

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

      - name: Baseline kill-rate threshold
        id: threshold
        run: echo "KILL_RATE_MIN=70" >> $GITHUB_ENV

      - name: Run mutation tests (critical services)
        run: |
          # Mutate only critical financial service layer
          mutmut run --paths-to-mutate transactions/services.py --tests-dir api || true
          mutmut results || true
        continue-on-error: true

      - name: Parse mutation results
        id: parse_mutation
        run: |
          python3 -c "
          import re, subprocess, json, sys
          try:
              out = subprocess.check_output(['mutmut','results'], text=True)
          except Exception:
              print('::notice ::Mutation results unavailable')
              print('KILL_RATE=0')
              sys.exit(0)
          survived = 0
          killed = 0
          for line in out.splitlines():
              if 'SURVIVED' in line:
                  m = re.search(r'(\d+)', line)
                  survived = int(m.group(1)) if m else survived
              if 'KILLED' in line:
                  m = re.search(r'(\d+)', line)
                  killed = int(m.group(1)) if m else killed
          total = survived + killed
          kill_rate = (killed/total*100) if total else 0
          print(f'Kill rate: {kill_rate:.2f}% (killed={killed}, survived={survived})')
          with open('mutation_summary.json','w') as f:
              json.dump({'killed':killed,'survived':survived,'kill_rate':kill_rate}, f)
          with open('GITHUB_OUTPUT', 'a') as f:
              f.write(f'kill_rate={kill_rate:.2f}\n')
          "

      - name: Upload mutation summary
        uses: actions/upload-artifact@v4
        with:
          name: mutation-summary
          path: mutation_summary.json

      - name: Enforce kill-rate threshold
        continue-on-error: true
        run: |
          echo "Required >= ${KILL_RATE_MIN}%"; echo "Actual: ${KILL_RATE}%"
          awk 'BEGIN {exit !(ENVIRON["KILL_RATE"]+0 >= ENVIRON["KILL_RATE_MIN"]+0)}'
        env:
          KILL_RATE: ${{ steps.parse_mutation.outputs.kill_rate }}

      - name: Summary
        run: |
          echo "Mutation testing completed." \
               "Kill rate: ${{ steps.parse_mutation.outputs.kill_rate }}%" \
               "Threshold: $KILL_RATE_MIN%"

  nightly-full-mutation:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      - run: |
          mutmut run --paths-to-mutate transactions --tests-dir api || true
          mutmut results || true